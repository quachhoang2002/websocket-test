<html>

<head>
    <title>Centrifugo quick start</title>
</head>

<body>
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <h2>Simple Chat</h2>

        <!-- Chat Messages Container -->
        <div id="messages"
            style="height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #f9f9f9;">
            <div style="text-align: center; color: #666;">Messages will appear here...</div>
        </div>

        <!-- Join/Leave Controls -->
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="userId" placeholder="Your name" value="User1" style="flex: 1; padding: 8px;">
            <input type="text" id="conversationChannel" placeholder="Conversation Channel" value="conversation:12345"
                style="flex: 1; padding: 8px;">
            <button onclick="joinConversation()"
                style="padding: 8px 16px; background: #28a745; color: white; border: none; cursor: pointer;">Join</button>
            <button onclick="leaveConversation()"
                style="padding: 8px 16px; background: #dc3545; color: white; border: none; cursor: pointer;">Leave</button>
        </div>

        <!-- Chat Input -->
        <div style="display: flex; gap: 10px;">
            <input type="text" id="messageInput" placeholder="Type your message..." style="flex: 3; padding: 8px;">
            <input type="text" id="notificationChannel" placeholder="Notification Channel" value="notification:12345"
                style="flex: 1; padding: 8px;">
            <button onclick="sendMessage()"
                style="padding: 8px 16px; background: #007bff; color: white; border: none; cursor: pointer;">Send</button>
        </div>

        <!-- Status -->
        <div id="status" style="margin-top: 10px; font-size: 12px; color: #666;">Connecting...</div>
    </div>
    <script src="https://unpkg.com/centrifuge@5.2.2/dist/centrifuge.js"></script>
    <script type="text/javascript">
        const messagesContainer = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const messageInput = document.getElementById('messageInput');
        const userIdInput = document.getElementById('userId');
        const conversationChannel = document.getElementById('conversationChannel');
        const notificationChannel = document.getElementById('notificationChannel');

        // Global variables for tracking state
        let isJoined = false;
        let currentSubscription = null;

        const centrifuge = new Centrifuge("ws://localhost:8000/connection/websocket", {
            token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM3MjIiLCJleHAiOjE3NTUxMTA3MzgsImlhdCI6MTc1NDUwNTkzOH0.GyTAy6mR0pjrTwQZJOFqPGsOPN6QveiNU5F0qX8ChRY"
        });

        centrifuge.on('connecting', function (ctx) {
            console.log(`connecting: ${ctx.code}, ${ctx.reason}`);
            statusDiv.textContent = 'Connecting...';
        }).on('connected', function (ctx) {
            console.log(`connected over ${ctx.transport}`);
            statusDiv.textContent = 'Connected';
            statusDiv.style.color = '#28a745';
        }).on('disconnected', function (ctx) {
            console.log(`disconnected: ${ctx.code}, ${ctx.reason}`);
            statusDiv.textContent = 'Disconnected';
            statusDiv.style.color = '#dc3545';
        }).connect();

        // Join conversation function
        function joinConversation() {
            const userId = userIdInput.value.trim();
            const channel = conversationChannel.value.trim();

            if (!userId || !channel) {
                alert('Please enter both your name and a conversation channel');
                return;
            }

            if (isJoined) {
                alert('You are already joined to a conversation');
                return;
            }

            // Unsubscribe from previous subscription if exists
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            // Create new subscription
            currentSubscription = centrifuge.newSubscription(channel);

            // Set up event handlers
            currentSubscription.on('publication', function (ctx) {
                console.log('New message received:', ctx.data);
                const message = ctx.data.message || 'No message';
                const userId = ctx.data.user_id || 'Unknown';
                const timestamp = ctx.data.timestamp || new Date().toISOString();

                // Create message element
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = 'border: 1px solid #ddd; padding: 8px; margin: 5px 0; background: white; border-radius: 5px;';
                messageDiv.innerHTML = `
                    <div style="font-weight: bold; color: #007bff;">${userId}</div>
                    <div style="margin: 5px 0;">${message}</div>
                    <div style="font-size: 11px; color: #666;">${new Date(timestamp).toLocaleTimeString()}</div>
                `;

                // Add to messages container
                messagesContainer.appendChild(messageDiv);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                document.title = `Chat - ${message}`;
            });

            currentSubscription.on('subscribing', function (ctx) {
                console.log(`Joining conversation: ${ctx.code}, ${ctx.reason}`);
                statusDiv.textContent = 'Joining conversation...';
            });

            currentSubscription.on('subscribed', function (ctx) {
                console.log('Successfully joined conversation', ctx);
                isJoined = true;
                statusDiv.textContent = `Joined: ${channel}`;
                statusDiv.style.color = '#28a745';

                // Add join message
                const joinDiv = document.createElement('div');
                joinDiv.style.cssText = 'border: 1px solid #28a745; padding: 8px; margin: 5px 0; background: #d4edda; border-radius: 5px; text-align: center;';
                joinDiv.innerHTML = `<strong style="color: #155724;">${userId} joined the conversation</strong>`;
                messagesContainer.appendChild(joinDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });

            currentSubscription.on('unsubscribed', function (ctx) {
                console.log(`Left conversation: ${ctx.code}, ${ctx.reason}`);
                isJoined = false;
                statusDiv.textContent = 'Disconnected';
                statusDiv.style.color = '#dc3545';
            });

            // Subscribe to the channel
            currentSubscription.subscribe();
        }

        // Leave conversation function
        function leaveConversation() {
            if (!isJoined || !currentSubscription) {
                alert('You are not currently joined to any conversation');
                return;
            }

            const userId = userIdInput.value.trim();

            // Add leave message
            const leaveDiv = document.createElement('div');
            leaveDiv.style.cssText = 'border: 1px solid #dc3545; padding: 8px; margin: 5px 0; background: #f8d7da; border-radius: 5px; text-align: center;';
            leaveDiv.innerHTML = `<strong style="color: #721c24;">${userId} left the conversation</strong>`;
            messagesContainer.appendChild(leaveDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Unsubscribe
            currentSubscription.unsubscribe();
            currentSubscription = null;
            isJoined = false;

            statusDiv.textContent = 'Disconnected';
            statusDiv.style.color = '#dc3545';
        }

        // Subscribe to notification channel
        const notificationSub = centrifuge.newSubscription(notificationChannel.value);

        notificationSub.on('publication', function (ctx) {
            console.log('New notification received:', ctx.data);
            const notification = ctx.data;

            // Show notification
            if (notification.title && notification.body) {
                alert(`${notification.title}: ${notification.body}`);
            }
        }).on('subscribing', function (ctx) {
            console.log(`subscribing to notification: ${ctx.code}, ${ctx.reason}`);
        }).on('subscribed', function (ctx) {
            console.log('subscribed to notification', ctx);
        }).on('unsubscribed', function (ctx) {
            console.log(`unsubscribed from notification: ${ctx.code}, ${ctx.reason}`);
        }).subscribe();

        // Send message function
        function sendMessage() {
            if (!isJoined) {
                alert('Please join a conversation first before sending messages');
                return;
            }

            const message = messageInput.value.trim();
            const userId = userIdInput.value.trim();

            if (!message || !userId) {
                alert('Please enter both your name and a message');
                return;
            }

            // Create message data
            const messageData = {
                message: message,
                user_id: userId,
                timestamp: new Date().toISOString()
            };

            // Try HTTP API first, fallback to console instruction
            fetch('http://localhost:8000/api/publish', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': '-Xb3LnkZmtz9HWUG4pf0HU-KScY8VqvDE8MuWmw_nq1cp4YlfE3CVjbFiUlKW3V7KZ22Ta7K9t1DPaWNEbpKnA'
                },
                mode: 'cors',
                credentials: 'omit',
                body: JSON.stringify({
                    channel: conversationChannel.value,
                    data: messageData
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    console.log('Message sent via HTTP API:', data);
                    messageInput.value = '';
                })
                .catch(error => {
                    console.error('HTTP API failed:', error);
                    console.log('To send message via Redis Stream, run this command:');
                    console.log(`XADD conversation_stream * method publish payload '{"channel": "${conversationChannel.value}", "data": ${JSON.stringify(messageData)}}'`);
                    alert('HTTP API failed. Check console for Redis Stream command to run manually.');
                    messageInput.value = '';
                });
        }

        // Handle Enter key
        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>

</html>